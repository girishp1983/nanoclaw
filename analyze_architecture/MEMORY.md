# Memory Model

## Overview
NanoClaw memory is layered. Different data types are persisted in different places for different purposes.

## Memory layers

### 1) Operational memory in SQLite

Database file: `store/messages.db`

Main tables involved:
- `messages`: stored inbound chat messages
- `chats`: chat metadata (name, last activity)
- `sessions`: `group_folder -> session_id` mapping
- `router_state`: cursors (`last_timestamp`, `last_agent_timestamp`)
- `registered_groups`: group registration and settings
- `scheduled_tasks` and `task_run_logs`: task state and history

This is the host's operational state and survives restart.

### 2) Session continuity pointer (DB)

- `sessions` table stores the latest Claude session ID per group.
- On agent output with `newSessionId`, host updates in-memory map and persists via `setSession(...)`.
- On startup, host reloads all sessions via `getAllSessions()`.

This is a pointer/index layer, not the full conversation artifact.

### 3) Claude session artifacts on disk

Per group path:
- `data/sessions/<group>/.claude/`

This directory is used as the agent HOME (effectively `~/.claude/` for that group runtime).
It contains Claude session/transcript artifacts and settings used by the SDK.

At spawn time, host ensures `settings.json` exists with:
- `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1`
- `CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD=1`
- `CLAUDE_CODE_DISABLE_AUTO_MEMORY=0` (auto memory enabled)

### 4) Group memory files (`CLAUDE.md`)

Primary per-group memory file:
- `groups/<group>/CLAUDE.md`

Optional shared/global memory file:
- `groups/global/CLAUDE.md`

Agent runs in group cwd and can use these as persistent instruction/memory documents.

### 5) Archived conversation memory

Before compaction, a pre-compact hook can archive transcripts as markdown under:
- `groups/<group>/conversations/`

This provides searchable long-term conversation history outside the live session stream.

Important distinction:
- Raw Claude session transcript artifacts are under:
  - `data/sessions/<group>/.claude/projects/.../*.jsonl`
- Archived markdown copies are under:
  - `groups/<group>/conversations/*.md`

For main group specifically:
- Raw session artifacts example:
  - `data/sessions/main/.claude/projects/-Users-girpatil-Documents-Coding-ClaudeCode-cowork-nanoclaw-groups-main/*.jsonl`
- Archive target folder:
  - `groups/main/conversations/`

`groups/main/conversations/` is created only when the pre-compact hook actually writes an archive, so it may not exist even when session `.jsonl` files already exist.

## How memory gets updated

### Message and metadata persistence

- Incoming WhatsApp events are stored via host callbacks:
  - `storeMessage(...)` for content
  - `storeChatMetadata(...)` for chat activity

### Session memory updates

- During agent runs, streamed outputs may include `newSessionId`.
- Host persists this with `setSession(...)`.
- Future runs can resume with that session ID.

### Task-related memory updates

- Task creation/update/delete goes through IPC -> DB (`scheduled_tasks`).
- Task execution outcomes are appended to `task_run_logs` and summarized in `scheduled_tasks.last_result`.

### File memory updates (`CLAUDE.md`)

- Updated only when explicitly written by user/agent/tooling.
- Not auto-generated by scheduler loops.

## Isolation model

Memory is isolated by group:
- session directory: `data/sessions/<group>/...`
- IPC namespace: `data/ipc/<group>/...`
- working directory and CLAUDE.md: `groups/<group>/...`

Main group has broader administrative permissions, but regular group memory does not automatically leak across groups.

## `group` vs `isolated` task context

For scheduled tasks:
- `context_mode='group'`: resumes group session when available.
- `context_mode='isolated'`: starts without group session continuity.

So two tasks with the same prompt can behave differently depending on context mode.

## What survives restart

Survives:
- SQLite data (`store/messages.db`)
- per-group session files (`data/sessions/...`)
- group files (`groups/...`, including `CLAUDE.md`)

Transient/in-memory only:
- process-local maps in `src/index.ts` (reloaded from DB on startup)

## Practical checks

Show session pointers:

```sql
SELECT group_folder, session_id FROM sessions;
```

Show last message activity:

```sql
SELECT chat_jid, MAX(timestamp) FROM messages GROUP BY chat_jid;
```

Show registered groups:

```sql
SELECT jid, name, folder, trigger_pattern FROM registered_groups;
```
